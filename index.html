<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>TP4 WebVR - Compatible (A-Frame 0.9.2, Physics 3.3.0)</title>
    <!-- Core -->
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <!-- Physics system -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@3.3.0/dist/aframe-physics-system.min.js"></script>
    <!-- Super-hands for VR grabbing -->
    <script src="https://unpkg.com/super-hands@3.0.3/dist/super-hands.min.js"></script>
    <!-- Particle system (optional effects) -->
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.9/dist/aframe-particle-system-component.min.js"></script>
    <!-- Sound component is built-in in aframe 0.9.2 -->
    <style>body { margin: 0; }</style>
    <script>
    // Utilitaires
    function readStickAxes(axis){
      // Certains profils/Ã©mulateurs envoient les sticks sur [2,3]
      const ax = axis || [];
      let x = ax[0] ?? 0, y = ax[1] ?? 0;
      if (Math.abs(x) < 0.001 && Math.abs(y) < 0.001 && ax.length >= 4) {
        x = ax[2] ?? 0; y = ax[3] ?? 0;
      }
      return {x, y};
    }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    // Joystick gauche = dÃ©placement (g/d inversÃ© corrigÃ©)
    AFRAME.registerComponent('left-stick-move', {
      schema: { speed: {type:'number', default:3}, deadzone:{type:'number', default:0.05} },
      init() {
        this.axis = {x:0,y:0};
        this.rig  = document.querySelector('#rig');
        this.cam  = document.querySelector('#head');
        this.el.addEventListener('axismove', e => { this.axis = readStickAxes(e.detail.axis); });
      },
      tick(t,dt){
        if(!this.rig||!this.cam) return;
        const s = this.data.speed*(dt/1000);
        let {x,y} = this.axis;
        if (Math.hypot(x,y) < this.data.deadzone) return;

        const yaw=(this.rig.getAttribute('rotation')?.y||0)+(this.cam.getAttribute('rotation')?.y||0);
        const rad=THREE.MathUtils.degToRad(yaw);
        const forward=new THREE.Vector3(-Math.sin(rad),0,-Math.cos(rad));
        const right  =new THREE.Vector3().crossVectors(forward,new THREE.Vector3(0,1,0)).negate();

        this.rig.object3D.position
          .addScaledVector(forward, -y*s)  // avancer/reculer (inverse si tu prÃ©fÃ¨res)
          .addScaledVector(right,   -x*s); // gauche/droite (inversÃ© corrigÃ©)
      }
    });

    // Joystick droit = yaw (VR+desktop) + pitch (desktop seulement)

    AFRAME.registerComponent('right-stick-turn', {
      schema:{ turnSpeed:{type:'number',default:120}, deadzone:{type:'number',default:0.08} },
      init(){
        this.x=0; this.y=0;
        this.rig   = document.querySelector('#rig');   // yaw
        this.pitch = document.querySelector('#pitch'); // pitch
        this.el.addEventListener('axismove', e => {
          const a = readStickAxes(e.detail.axis);
          this.x = a.x; this.y = a.y;
        });
      },
      tick(t,dt){
        if(!this.rig || !this.pitch) return;
        const s = this.data.turnSpeed * (dt/1000);

        // --- YAW : rotation autour de Y (gauche/droite) ---
        if (Math.abs(this.x) >= this.data.deadzone) {
          const rot = this.rig.getAttribute('rotation') || {x:0,y:0,z:0};
          rot.y -= this.x * s;   // gauche/droite
          this.rig.setAttribute('rotation', rot);
        }

        // --- PITCH : rotation autour de X (haut/bas) ---
        if (Math.abs(this.y) >= this.data.deadzone) {
          const pr = this.pitch.getAttribute('rotation') || {x:0,y:0,z:0};
          pr.x = clamp(pr.x + (-this.y * s), -80, 80); // limitÃ© entre -80Â° et +80Â°
          pr.z = 0; // sÃ©curitÃ© : pas de roll
          this.pitch.setAttribute('rotation', pr);
        }
      }
    });

    // Gun and shooting logic
    AFRAME.registerComponent('shootable', {
      init: function () {
        this.el.addEventListener('triggerdown', () => {
          var bullet = document.createElement('a-sphere');
          bullet.setAttribute('radius', '0.07');
          bullet.setAttribute('color', '#FFD700');
          bullet.setAttribute('dynamic-body', 'mass:0.18; shape: sphere;');
          var pos = this.el.object3D.getWorldPosition(new THREE.Vector3());
          bullet.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
          var dir = new THREE.Vector3();
          this.el.object3D.getWorldDirection(dir);
          dir.multiplyScalar(-8);
          bullet.addEventListener('body-loaded', function () {
            bullet.body.velocity.set(dir.x, dir.y, dir.z);
          });
          this.el.sceneEl.appendChild(bullet);
          setTimeout(()=>bullet.parentNode && bullet.parentNode.removeChild(bullet), 2000);
        });
      }
    });

    // Spawn random targets (Ex 4)
    function spawnTarget() {
      var target = document.createElement('a-box');
      target.setAttribute('height', "0.6"); target.setAttribute('width', "0.6");
      target.setAttribute('depth', "0.6"); target.setAttribute('color', "#A23");
      let x = (Math.random()*10)-5, y = 1.2+Math.random(), z = (Math.random()*-8)-2;
      target.setAttribute('position', `${x} ${y} ${z}`);
      target.setAttribute('dynamic-body', "");
      // On hit (collide): play sound, particles, remove target
      target.addEventListener('collide', function (e) {
        if (e.detail.body.el && e.detail.body.el.getAttribute('radius') === 0.07) {
          let part = document.createElement('a-entity');
          part.setAttribute('particle-system', 'preset: dust; color: #FFF, #99F;');
          part.setAttribute('position', target.getAttribute('position'));
          target.sceneEl.appendChild(part);
          // Sound on hit
          let snd = document.createElement('a-sound');
          snd.setAttribute('src', '#hit-sound'); // defined below
          snd.setAttribute('autoplay', 'true');
          snd.setAttribute('volume', '3');
          part.appendChild(snd);
          target.parentNode.removeChild(target);
        }
      });
      document.querySelector('a-scene').appendChild(target);
    }
    setInterval(spawnTarget, 2000);
    </script>
  </head>
  <body>
    <div class="hud">ðŸŽ® Gauche: dÃ©placer â€” Droite: tourner (desktop: stick droit = yaw + pitch)</div>

    <a-scene physics="gravity: -9.8" shadow="type: pcfsoft" renderer="antialias:true; physicallyCorrectLights:true; colorManagement:true; logarithmicDepthBuffer:true; sortTransparentObjects:true">

      <!-- Sound asset -->
      <a-assets>
        <audio id="hit-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_11c0e6ddb7.mp3"></audio>
      </a-assets>
      <!-- Ground -->
      <a-plane position="0 0 0" rotation="-90 0 0" width="40" height="40" color="#7BC8A4"
        static-body shadow="receive: true"></a-plane>
      <a-entity id="ground" geometry="primitive:plane;width:40;height:40"
        rotation="-90 0 0" material="color:#7da07d;roughness:1;metalness:0"
        shadow="receive:true"></a-entity>
      <!-- Box & Sphere: to grab/test physics -->
      <a-box position="-1 2 -2" grabbable dynamic-body color="#4CC3D9" shadow="cast:true;receive:true"></a-box>
      <a-sphere position="2 1.5 -3" radius="0.6" grabbable dynamic-body color="#EF2D5E" shadow="cast:true;receive:true"></a-sphere>
      <!-- Weapon -->
      <a-box id="gun" position="0 1.5 0" color="#333" grabbable dynamic-body width="0.3" height="0.12" depth="0.6" shootable></a-box>
      <!-- Lights -->
      <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="2 7 2"></a-entity>
      <a-entity light="type: ambient; color: #BBB"></a-entity>
      <!-- VR controls rig -->
      <a-entity id="rig" position="0 1.6 5" rotation="0 0 0" wasd-controls="acceleration:20">
      <a-entity id="pitch" rotation="0 0 0">
          <a-entity id="head" camera look-controls="pointerLockEnabled: true"></a-entity>

          <!-- DÃ©place les contrÃ´leurs ici pour qu'ils suivent aussi le pitch -->
          <a-entity id="left"  laser-controls="hand: left"  left-stick-move="speed:3"></a-entity>
          <a-entity id="right" laser-controls="hand: right" right-stick-turn="turnSpeed:120; deadzone:0.08"></a-entity>
        </a-entity>
      </a-entity>
      <a-entity teleport-controls="enabled: false"></a-entity>
    </a-scene>
  </body>
</html>
