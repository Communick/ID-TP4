<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>TP WebVR Physics Lab (A-Frame 1.7.0 + Extras + Physics + SuperHands)</title>
    <!-- The order matters for compatibility! -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script> delete AFRAME.components["grabbable"]; </script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>
    <style>body {margin:0}</style>
    <script>
    // Gun shooting (grab gun, trigger = shoot)
    AFRAME.registerComponent('shootable', {
      init: function () {
        this.el.addEventListener('triggerdown', () => {
          const bullet = document.createElement('a-sphere');
          bullet.setAttribute('radius', '0.08');
          bullet.setAttribute('color', '#FFD700');
          bullet.setAttribute('dynamic-body', 'mass:0.13');
          // Put bullet at current weapon position
          const pos = this.el.object3D.getWorldPosition(new THREE.Vector3());
          bullet.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
          const dir = new THREE.Vector3();
          this.el.object3D.getWorldDirection(dir);
          dir.multiplyScalar(-12);
          bullet.addEventListener('body-loaded', function () {
            bullet.body.velocity.set(dir.x, dir.y, dir.z);
          });
          this.el.sceneEl.appendChild(bullet);
          setTimeout(()=>bullet.parentNode && bullet.parentNode.removeChild(bullet), 2200);
        });
      }
    });
    // Spawn random targets with effect on hit
    function spawnTarget() {
      const target = document.createElement('a-box');
      target.setAttribute('height', "0.5");
      target.setAttribute('width', "0.5");
      target.setAttribute('depth', "0.5");
      target.setAttribute('color', "#EC3");
      let x = Math.random()*10-5, y = 1.2+Math.random(), z = Math.random()*-7-2;
      target.setAttribute('position', `${x} ${y} ${z}`);
      target.setAttribute('dynamic-body', "");
      target.addEventListener('collide', function (e) {
        if (e.detail.body.el && e.detail.body.el.getAttribute('radius') === 0.08) {
          target.setAttribute('color', '#05E');
          setTimeout(()=>target.parentNode && target.parentNode.removeChild(target), 300);
        }
      });
      document.querySelector('a-scene').appendChild(target);
    }
    setInterval(spawnTarget, 1750);
    </script>
  </head>
  <body>
    <a-scene physics="gravity: -9.8">
      <!-- GROUND -->
      <a-plane color="#7BC8A4" rotation="-90 0 0" width="14" height="14"
        static-body shadow="receive: true"></a-plane>
      <!-- PHYSICS OBJECTS TO GRAB/THROW -->
      <a-box position="-1 2 -2" dynamic-body
             super-hands="colliderEvent: collisions; grabStartButtons: triggerdown, gripdown; grabEndButtons: triggerup, gripup"
             shadow="cast:true;receive:true"></a-box>
      <a-sphere position="2 2 -4" radius="0.55" dynamic-body
             super-hands="colliderEvent: collisions; grabStartButtons: triggerdown, gripdown; grabEndButtons: triggerup, gripup"
             color="#96FF96" shadow="cast:true;receive:true"></a-sphere>
      <a-cylinder position="0 4 -1" radius="0.35" height="1" dynamic-body
             super-hands="colliderEvent: collisions; grabStartButtons: triggerdown, gripdown; grabEndButtons: triggerup, gripup"
             color="#FF9090" shadow="cast:true;receive:true"></a-cylinder>
      <!-- VR WEAPON (GUN) FOR SHOOTING BALLS -->
      <a-box id="gun" position="0 1.5 0" color="#222" dynamic-body
             width="0.28" height="0.12" depth="0.6"
             super-hands="colliderEvent: collisions; grabStartButtons: triggerdown, gripdown; grabEndButtons: triggerup, gripup"
             shootable></a-box>
      <!-- LIGHTS -->
      <a-entity light="type: directional; intensity: 1.1; castShadow: true" position="2 7 2"></a-entity>
      <a-entity light="type: ambient; color: #BBB"></a-entity>
      <!-- VR CAMERA + HANDS + MOVEMENT -->
      <a-entity id="rig" movement-controls="speed: 0.22; fly: false;" position="0 1.6 8">
        <a-entity camera look-controls wasd-controls position="0 0 0"></a-entity>
        <a-entity hand-controls="hand: left" super-hands="colliderEvent: collisions"></a-entity>
        <a-entity hand-controls="hand: right" super-hands="colliderEvent: collisions"></a-entity>
      </a-entity>
      <a-entity teleport-controls="enabled: false"></a-entity>
    </a-scene>
  </body>
</html>
