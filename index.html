<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>TP4 WebVR â€“ Movement with aframe-extras</title>
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@3.3.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@4.1.2/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/super-hands@3.0.3/dist/super-hands.min.js"></script>
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.9/dist/aframe-particle-system-component.min.js"></script>
    <script>
    // Gun shooting (Exercise 3, left unchanged)
    AFRAME.registerComponent('shootable', {
      init: function () {
        this.el.addEventListener('triggerdown', () => {
          var bullet = document.createElement('a-sphere');
          bullet.setAttribute('radius', '0.07');
          bullet.setAttribute('color', '#FFD700');
          bullet.setAttribute('dynamic-body', 'mass:0.2');
          var pos = this.el.object3D.getWorldPosition(new THREE.Vector3());
          bullet.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
          var dir = new THREE.Vector3();
          this.el.object3D.getWorldDirection(dir);
          dir.multiplyScalar(-8);
          bullet.addEventListener('body-loaded', function () {
            bullet.body.velocity.set(dir.x, dir.y, dir.z);
          });
          this.el.sceneEl.appendChild(bullet);
          setTimeout(()=>bullet.parentNode && bullet.parentNode.removeChild(bullet), 2000);
        });
      }
    });
    // Random target generator (Exercise 4, left unchanged)
    function spawnTarget() {
      var target = document.createElement('a-box');
      target.setAttribute('height', "0.4"); target.setAttribute('width', "0.4");
      target.setAttribute('depth', "0.4"); target.setAttribute('color', "#A23");
      let x = (Math.random() * 6) - 3, y = 1 + Math.random(), z = (Math.random() * 4) - 6;
      target.setAttribute('position', `${x} ${y} ${z}`);
      target.setAttribute('dynamic-body', "");
      target.addEventListener('collide', function (e) {
        if (e.detail.body.el && e.detail.body.el.getAttribute('radius') === 0.07) {
          let part = document.createElement('a-entity');
          part.setAttribute('particle-system', 'preset: dust; color: #FFF, #99F;');
          part.setAttribute('position', target.getAttribute('position'));
          target.sceneEl.appendChild(part);
          target.parentNode.removeChild(target);
        }
      });
      document.querySelector('a-scene').appendChild(target);
    }
    setInterval(spawnTarget, 2000);
    </script>
  </head>
  <body>
    <a-scene physics="gravity: -9.8">
      <a-plane position="0 0 0" rotation="-90 0 0" width="10" height="10"
        color="#7BC8A4" static-body shadow="receive: true"></a-plane>
      <a-box position="-1 0.5 -3" grabbable dynamic-body color="#4CC3D9" shadow="cast:true;receive:true"></a-box>
      <a-sphere position="2 1 -3" radius="0.7" grabbable dynamic-body color="#EF2D5E" shadow="cast:true;receive:true"></a-sphere>
      <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="0 4 2"></a-entity>
      <a-entity light="type: ambient; color: #BBB"></a-entity>
      <a-box id="gun" position="0 1.2 -1" color="#222" grabbable dynamic-body width="0.2" height="0.12" depth="0.4" shootable></a-box>

      <!-- aframe-extras movement-controls does analog sticks, WASD, and thumbstick! -->
      <a-entity id="rig"
        movement-controls="fly: false; speed: 0.12; constrainToNavMesh: false">
        <a-entity camera look-controls position="0 1.6 4"></a-entity>
        <a-entity hand-controls="hand: left; modelStyle: lowPoly; handModelStyle: disabled" super-hands></a-entity>
        <a-entity hand-controls="hand: right; modelStyle: lowPoly; handModelStyle: disabled" super-hands></a-entity>
      </a-entity>
      <a-entity teleport-controls="enabled: false"></a-entity>
    </a-scene>
  </body>
</html>
